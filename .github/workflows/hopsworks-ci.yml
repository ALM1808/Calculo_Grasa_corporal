name: Hopsworks CI

on:
  workflow_dispatch:  # permitir lanzarlo manualmente desde Actions
  push:
    branches: [ main ]
    paths:
      - "pipeline/**"
      - "models/**"
      - "requirements.txt"
  schedule:
    - cron: "0 6 * * *"   # todos los días 06:00 UTC (08:00 Madrid aprox)

jobs:
  register:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Train or Register in Model Registry
        env:
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
          HOPSWORKS_PROJECT: GrasaCorporal
          HOPSWORKS_HOST: c.app.hopsworks.ai
        run: |
          python pipeline/train_or_register.py

  batch-infer:
    needs: register
    runs-on: ubuntu-latest
    if: ${{ always() }}   # ejecuta aunque el job anterior no entrene
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Batch inference → user_fat_predictions
        env:
          HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
          HOPSWORKS_PROJECT: GrasaCorporal
          HOPSWORKS_HOST: c.app.hopsworks.ai
        run: |
          python pipeline/batch_infer.py
